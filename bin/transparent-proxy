#!/bin/bash
#
# Run [jpetazzo/squid-in-a-can](https://github.com/jpetazzo/squid-in-a-can) as a transparent http proxy
# on this machine. This should speed up apt for other containers and the host.

sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to 3129 -w
function iptablescleanup {
  sudo iptables -t nat -D PREROUTING -p tcp --dport 80 -j REDIRECT --to 3129 -w
}
trap iptablescleanup EXIT

docker run \
  --net host \
  --name transparent-proxy \
  -v /var/cache/squid3:/var/cache/squid3 \
  -d \
  jpetazzo/squid-in-a-can

read -p "Press enter to stop the proxy" key
docker rm -f transparent-proxy
